# RusWaCipher Web Runtime

This directory contains the browser-side JavaScript runtime for decrypting and loading encrypted WebAssembly modules.

## üìÅ Files

- **`wasmGuardianLoader.js`** - Main JavaScript loader for encrypted WASM modules
- **`test.html`** - Basic test page for manual testing
- **`test-enhanced.html`** - Automated test page (generated by test script)
- **`test-config.json`** - Test configuration with keys (generated by test script)

## üöÄ Quick Start

### 1. Build and Test

Run the comprehensive test script:

```bash
# From the project root
./scripts/test-web-runtime.sh
```

This script will:
- Build the main ruswacipher tool
- Create a test WASM module
- Encrypt it with both AES-GCM and ChaCha20-Poly1305
- Generate test keys
- Start a local HTTP server for testing

### 2. Manual Testing

If you prefer manual testing:

```bash
# Build test WASM
cd test-wasm
./build.sh
cd ..

# Encrypt the test WASM
cargo run -- encrypt -i web/test.wasm -o web/test.wasm.enc -a aes-gcm --generate-key web/test.key

# Serve the web directory
cd web
python3 -m http.server 8000

# Open http://localhost:8000/test.html in your browser
```

## üîß Usage

### Basic Usage

```javascript
// Create loader instance
const loader = new WasmGuardianLoader();

// Load encrypted WASM
const wasmInstance = await loader.loadEncryptedWasm(
    'encrypted-module.wasm.enc',  // URL to encrypted WASM
    'deadbeef...',                // Hex key
    {},                           // WASM imports (optional)
    'aes-gcm'                     // Algorithm (optional, defaults to 'aes-gcm')
);

// Use the WASM module
const result = wasmInstance.exports.myFunction(42);
```

### Supported Algorithms

- **AES-GCM** - Uses browser's SubtleCrypto API (recommended for production)
- **ChaCha20-Poly1305** - Uses WASM helper module (implementation in progress)

### Error Handling

```javascript
try {
    const wasmInstance = await loader.loadEncryptedWasm(url, key);
    // Use wasmInstance...
} catch (error) {
    console.error('Failed to load encrypted WASM:', error.message);
}
```

## üß™ Testing

### Test Cases Included

1. **Basic Functionality Test** - Validates loader initialization and input validation
2. **AES-GCM Decryption Test** - Tests full encrypt ‚Üí decrypt ‚Üí instantiate pipeline
3. **ChaCha20-Poly1305 Test** - Tests alternative algorithm (requires WASM helper)
4. **Invalid Input Tests** - Validates error handling

### Test WASM Functions

The test WASM module includes:

- `add(a, b)` - Simple addition function
- `multiply(a, b)` - Simple multiplication function  
- `greet(name)` - String manipulation function
- `sum_array(numbers)` - Array processing function

## üîê Security Considerations

### Browser Environment Limitations

- **Key Exposure**: Decryption keys must be available in JavaScript
- **Memory Dumps**: Decrypted WASM exists in browser memory
- **Network Traffic**: Keys may be transmitted over network

### Recommended Practices

1. **Use HTTPS**: Always serve encrypted WASM over HTTPS
2. **Key Management**: Consider server-side key derivation
3. **Obfuscation**: Combine with code obfuscation for additional protection
4. **Runtime Checks**: Implement integrity checks in WASM code

## üõ†Ô∏è Development

### Adding New Algorithms

1. Implement decryption logic in `_decryptWasm()` method
2. Add algorithm to `supportedAlgorithms` array
3. Update algorithm selection in `_decryptWasm()` switch statement
4. Add corresponding tests

### WASM Helper Module (ChaCha20-Poly1305)

The ChaCha20-Poly1305 implementation requires a WASM helper module:

```javascript
// Future implementation
const wasmHelper = await import('./wasm-decryptor-helper.js');
await wasmHelper.default();
this.wasmDecryptorHelper = wasmHelper;
```

## üìä Performance

### Benchmarks (Approximate)

- **AES-GCM Decryption**: ~50MB/s (depends on browser and hardware)
- **WASM Instantiation**: ~100MB/s for typical modules
- **Memory Overhead**: ~2x during decryption (temporary buffers)

### Optimization Tips

1. **Streaming**: Consider implementing streaming decryption for large modules
2. **Web Workers**: Offload decryption to prevent UI blocking
3. **Caching**: Cache decrypted modules when appropriate
4. **Compression**: Combine with compression before encryption

## üêõ Troubleshooting

### Common Issues

**"SubtleCrypto API not available"**
- Ensure page is served over HTTPS or localhost
- Check browser compatibility

**"Invalid WASM magic number"**
- Verify decryption key is correct
- Check that file was encrypted with matching algorithm

**"Failed to fetch encrypted WASM"**
- Verify file path and server configuration
- Check CORS headers if loading from different domain

**"WASM instantiation failed"**
- Ensure WASM imports are correctly provided
- Verify WASM module is valid before encryption

### Debug Mode

Enable verbose logging:

```javascript
// The loader automatically logs to console
// Check browser developer tools for detailed logs
```

## üìö API Reference

### WasmGuardianLoader Class

#### Constructor
```javascript
new WasmGuardianLoader()
```

#### Methods

**`loadEncryptedWasm(url, keyHex, imports?, algorithm?)`**
- `url`: String - URL to encrypted WASM file
- `keyHex`: String - Decryption key in hexadecimal format
- `imports`: Object - WASM import object (optional)
- `algorithm`: String - Encryption algorithm (optional, default: 'aes-gcm')
- Returns: Promise<WebAssembly.Instance>

**`getInfo()`**
- Returns: Object with loader information and capabilities

## üîÑ Version History

- **v0.1.0** - Initial implementation with AES-GCM support
- **v0.2.0** - (Planned) ChaCha20-Poly1305 support via WASM helper
- **v0.3.0** - (Planned) Streaming decryption and Web Worker support
